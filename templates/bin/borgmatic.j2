{#
SPDX-FileCopyrightText: 2023 Nikita Chernyi

SPDX-License-Identifier: AGPL-3.0-or-later
#}

#!/usr/bin/env bash

{{ sysd_docker_host_command }} run --rm --name {{ backup_id }} \
    --log-driver=none \
    --cap-drop=ALL \
    --cap-add=CAP_DAC_OVERRIDE \
    --read-only \
    --network={{ backup_container_net }} \
    --mount type=bind,src={{ backup_conf_path }}/passwd,dst=/etc/passwd,ro \
    --mount type=bind,src={{ backup_conf_path }},dst=/etc/borgmatic.d,ro \
    --mount type=bind,src={{ backup_restore_path }},dst=/restore \
    {% for source in backup_location_source_directories %}
    --mount type=bind,src={{ source }},dst={{ source }},ro \
    {% endfor %}
    --tmpfs=/root:rw,noexec,nosuid,size={{ backup_container_tmpfs_root_size }} \
    --tmpfs=/tmp:rw,noexec,nosuid,size={{ backup_container_tmpfs_tmp_size }} \
    {% for arg in backup_container_extra_arguments %}
    {{ arg }} \
    {% endfor %}
    {{ backup_docker_image }} \
    borgmatic "$@"
